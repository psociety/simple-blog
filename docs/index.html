<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Akaya+Telivigala&display=swap" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
        <title>Loading</title>
        <style>
            a {
                text-decoration: none;
                color: #404040;
            }
            a:focus, a:hover {
                text-decoration: none;
                color: #0085A1;
            }
            h1 {
                font-weight: 800;
                line-height: 1.1;
            }
            .post-meta {
                color: #808080;
                font-style: italic;
            }
            .social-share-section .bi-linkedin {
                color: #fff;
                background-color: #007bb6;
            }
            .social-share-section .bi-facebook {
                color: #007bb6;
                background-color: #fff;
            }
            .social-share-section .bi-twitter {
                color: #fff;
                background-color: #55acee;
            }
        </style>
    </head>
    <body>
        <div class="container-fluid d-flex min-vh-100 flex-column p-0">
            <nav class="navbar navbar-light bg-light justify-content-between navbar-expand-lg">
              <div class="container-fluid">
                <a class="navbar-brand" href="?">
                  <div id="global-loader" style="display: none"><i class="fas fa-spinner fa-spin"></i></div>
                </a>
                <div class="navbar-nav">
                    <a href="?">Home</a>
                </div>
              </div>
            </nav>
            <main id="main-container" role="main" class="flex-fill d-flex flex-column">
            </main>
            <footer class="pl-5 pt-3">
                <div class="row p-0 m-0">
                    <div class="col-12 text-center">
                        Barcos y Frutas Multimedia, S.L
                    </div>
                </div>
            </footer>
        </div>
        <script type="text/template" id="tpl-home">
            <div class="container">
                <div class="row">
    		        <div class="col-12">
                    <% entries.forEach(entry => { %>
                        <article>
                            <a href="<%= entry.url %>">
                                <h2 class="post-title"><%= entry.title %></h2>
                            </a>
                            <p class="post-meta">
                                Posted on <%= seger.formatDate(entry.date) %>
                            </p>
                            <div class="post-entry">
                                <%= entry.preview %>
                                <a href="<%= entry.url %>" class="post-read-more"><strong>[Read More]</strong></a>
                            </div>
                        </article>
                    <% }) %>
                    </div>
                </div>
            </div>
        </script>
        <script type="text/template" id="tpl-post">
            <div>
                <header>
                    <div class="container-md">
                        <div class="row">
                            <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
                                <h1><%= entry.title %></h1>
                            </div>
                        </div>
                    </div>
                </header>
                <div class="container-md">
                    <article>
                    <%= entry.html %>
                    </article>
                </div>
                <section class="social-share-section">
                    <span>Share: </span>
                    <a href="https://twitter.com/intent/tweet?text=<%= encodeURIComponent(entry.title) %>&amp;url=<%= encodeURIComponent(location.href) %>" class="btn" title="Share on Twitter">
                      <span class="bi bi-twitter" aria-hidden="true"></span>
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u=<%= encodeURIComponent(location.href) %>" class="btn" title="Share on Facebook">
                      <span class="bi bi-facebook" aria-hidden="true"></span>
                    </a>
                    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=<%= encodeURIComponent(location.href) %>" class="btn" title="Share on LinkedIn">
                      <span class="bi bi-linkedin" aria-hidden="true"></span>
                    </a>
                </section>
            </div>
        </script>
        <script src="https://cdn.jsdelivr.net/npm/underscore@1.11.0/underscore-min.js"></script>
        <script>
            class Seger {
                
                constructor() {
                    this.mainContainer = document.getElementById('main-container');

                    this.getConfig().then(() => {
                        this.setup();
                        
                        this.goTo(this.getCurrentRoute());
                    });
                }
                
                setup () {
                    document.querySelector('.navbar-brand').innerText = this.config.title;
                    
                    this.setupListeners();
                }
                
                goTo (route) {
                    const splitted = route.split("/");

                    if (route.length === 0) {
                        return this.showHome();
                    } else if (splitted[0] === 'post') {
                        const slug = splitted[1];
                        return this.showPost(slug);
                    } else if (splitted[0] === 'blog-editor') {
                        
                    }
                }
                
                getLanguage = () => {
                    return navigator.userLanguage || (navigator.languages && navigator.languages.length && navigator.languages[0]) || navigator.language || navigator.browserLanguage || navigator.systemLanguage || 'en';
                }
                
                formatDate(date) {
                    return (new Date(date)).toLocaleString(this.getLanguage(), {
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric'});
                }
                
                getCurrentRoute () {
                    return this.getRoute(location.search);
                }
                
                getRoute (queryString) {
                    if (queryString.length === 0) {
                        return "";
                    }
                    const route = (new URLSearchParams(queryString)).entries().next().value;
                    
                    if (!route[0].startsWith("/") || route[1].length > 0) {
                        return "";
                    }

                    return route[0].substr(1);
                }
                
                setupListeners () {
                    document.addEventListener("click", (e) => {
                        const a = e.target.closest("a");
                        
                        // not clicking a local link
                        if (a == null || !a.href.startsWith(location.origin + location.pathname)) {
                            return;
                        }
                        // avoid redirecting but change the url
                        e.preventDefault();
                        history.pushState({}, '', a.href);
                        
                        const route = this.getRoute(new URL(a.href).search);
                        
                        this.goTo(route);
                    });

                    // detect when user goes back/forward through navigation history
                    window.addEventListener("popstate", (e) => {
                        this.goTo(this.getCurrentRoute());
                    });
                }
                
                getTemplate(name) {
                    return document.getElementById("tpl-" + name).innerHTML.trim();
                }

                parseTemplate(name, data) {
                    let parsedTemplate = _.template(this.getTemplate(name))(data);
                    let div = document.createElement('div');
                    div.innerHTML = parsedTemplate;
                    
                    return div.firstChild; 
                }
                
                getEntry (slug) {
                    return new Promise((resolve, reject) => {
                        this.config.entries.forEach(entry => {
                            if (entry.slug === slug) {
                                resolve(entry);
                            }
                        });
                    });
                }
                
                getFullEntry (slug) {
                    return new Promise((resolve, reject) => {
                        this.getEntry(slug).then((entry) => {
                            if (typeof entry.html !== 'undefined') {
                                resolve(entry);
                                return;
                            }
                            fetch('posts/' + slug + "/index.html")
                                .then(response => response.text())
                                .then(html => {
                                    html = html.replace(/src="((?!http).+)"/, 'src="posts/' + slug + '/$1"');
                                    return html;
                                })
                                .then(html => {
                                    entry.html = html;
                                    resolve(entry);
                                });
                        });
                    });
                }

                getConfig () {
                    return fetch('config.json')
                      .then(response => response.json())
                      .then(config => {
                          this.config = config;
                          
                          this.config.entries.forEach(entry => {
                              entry.url = "?/post/" + entry.slug;
                          });
                      });
                }
                
                setTitle (title) {
                    document.title = title + " - " + this.config.title;
                }
                
                showPost (slug) {
                    this.getFullEntry(slug).then((entry) => {
                        this.setTitle(entry.title);
                        this.render(this.parseTemplate("post", {entry}));
                    });
                }
                
                showHome () {
                    this.setTitle("Home");
                    this.render(this.parseTemplate("home", {
                        entries: this.config.entries
                    }));
                }
                
                render (html) {
                    this.mainContainer.innerHTML = '';
                    this.mainContainer.appendChild(html);
                }
            }
            window.seger = new Seger();
            
        </script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css">
    </body>
</html>
